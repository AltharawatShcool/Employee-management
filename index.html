<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة شؤون الموظفين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4b4ba8',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        
        :root {
            --primary: #5D5CDE;
            --secondary: #4b4ba8;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
        }

        .dark {
            color-scheme: dark;
        }

        .dark .bg-white {
            background-color: #181818;
        }

        .dark .text-gray-800 {
            color: #e0e0e0;
        }

        .dark .text-gray-700 {
            color: #d0d0d0;
        }

        .dark .text-gray-600 {
            color: #c0c0c0;
        }

        .dark .border-gray-200 {
            border-color: #303030;
        }

        .dark .bg-gray-100 {
            background-color: #222222;
        }

        .dark .bg-gray-50 {
            background-color: #1c1c1c;
        }

        .dark .shadow {
            --tw-shadow-color: rgba(0, 0, 0, 0.3);
        }

        .dark input, .dark select, .dark textarea {
            background-color: #262626;
            color: #e0e0e0;
            border-color: #404040;
        }

        .dark input::placeholder, .dark textarea::placeholder {
            color: #888888;
        }

        .dark table th {
            background-color: #222222;
        }

        .dark table tr:nth-child(even) {
            background-color: #1e1e1e;
        }

        .dark table tr:nth-child(odd) {
            background-color: #262626;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Pop notifications */
        .notification-bubble {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Loading spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .help-tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .help-tooltip .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; 
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .help-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .help-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(93, 92, 222, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(93, 92, 222, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(93, 92, 222, 0);
            }
        }
        
        /* Estilos adicionales para mejorar la responsividad */
        @media (max-width: 768px) {
            .md\:mr-64 {
                margin-right: 0 !important;
            }
            
            .md\:w-64 {
                width: 100% !important;
            }
            
            .md\:fixed {
                position: fixed !important;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 50;
            }
            
            .md\:fixed.open {
                transform: translateX(0);
            }
        }
        
        /* Estilo para inputs en modo oscuro */
        .dark input, .dark select, .dark textarea {
            color-scheme: dark;
        }
        
        /* Mejorar contraste en el modo oscuro */
        .dark .notification-filter, 
        .dark .bg-gray-200 {
            background-color: #2d2d2d;
        }
        
        .dark .notification-filter:hover, 
        .dark .bg-gray-200:hover {
            background-color: #3d3d3d;
        }
        
        /* Mejor accesibilidad con foco */
        button:focus, 
        input:focus, 
        select:focus, 
        textarea:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p class="text-white mt-4 font-bold">جاري التحميل...</p>
    </div>

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <div class="bg-white dark:bg-gray-800 shadow md:w-64 md:fixed md:h-screen z-10 transition-all duration-300 ease-in-out" id="sidebar">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-primary">نظام شؤون الموظفين</h1>
            </div>
            <nav class="mt-6">
                <ul>
                    <li class="relative px-6 py-3">
                        <button id="nav-dashboard" class="inline-flex items-center w-full text-lg font-semibold py-3 px-2 transition-colors duration-150 hover:text-primary" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt ml-3"></i>
                            <span>لوحة المعلومات</span>
                        </button>
                    </li>
                    <li class="relative px-6 py-3">
                        <button id="nav-employees" class="inline-flex items-center w-full text-lg font-semibold py-3 px-2 transition-colors duration-150 hover:text-primary" onclick="showSection('employees')">
                            <i class="fas fa-users ml-3"></i>
                            <span>الموظفين</span>
                        </button>
                    </li>
                    <li class="relative px-6 py-3">
                        <button id="nav-contracts" class="inline-flex items-center w-full text-lg font-semibold py-3 px-2 transition-colors duration-150 hover:text-primary" onclick="showSection('contracts')">
                            <i class="fas fa-file-contract ml-3"></i>
                            <span>العقود</span>
                        </button>
                    </li>
                    <li class="relative px-6 py-3">
                        <button id="nav-leave" class="inline-flex items-center w-full text-lg font-semibold py-3 px-2 transition-colors duration-150 hover:text-primary" onclick="showSection('leave')">
                            <i class="fas fa-calendar-alt ml-3"></i>
                            <span>الإجازات</span>
                        </button>
                    </li>
                    <li class="relative px-6 py-3">
                        <button id="nav-absence" class="inline-flex items-center w-full text-lg font-semibold py-3 px-2 transition-colors duration-150 hover:text-primary" onclick="showSection('absence')">
                            <i class="fas fa-user-clock ml-3"></i>
                            <span>غياب الموظفين</span>
                        </button>
                    </li>
                    <li class="relative px-6 py-3">
                        <button id="nav-ex-employees" class="inline-flex items-center w-full text-lg font-semibold py-3 px-2 transition-colors duration-150 hover:text-primary" onclick="showSection('ex-employees')">
                            <i class="fas fa-user-slash ml-3"></i>
                            <span>الموظفين المنتهين</span>
                        </button>
                    </li>
                    <li class="relative px-6 py-3">
                        <button id="nav-import-export" class="inline-flex items-center w-full text-lg font-semibold py-3 px-2 transition-colors duration-150 hover:text-primary" onclick="showSection('import-export')">
                            <i class="fas fa-file-excel ml-3"></i>
                            <span>استيراد/تصدير</span>
                        </button>
                    </li>
                    <li class="relative px-6 py-3">
                        <button id="nav-reports" class="inline-flex items-center w-full text-lg font-semibold py-3 px-2 transition-colors duration-150 hover:text-primary" onclick="showSection('reports')">
                            <i class="fas fa-chart-bar ml-3"></i>
                            <span>التقارير</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="md:mr-64 flex-1" id="main-content">
            <header class="bg-white dark:bg-gray-800 shadow py-4 px-6 flex justify-between items-center">
                <div class="flex items-center">
                    <button id="sidebarToggle" class="p-1 md:hidden">
                        <i class="fas fa-bars text-gray-700 dark:text-gray-300"></i>
                    </button>
                    <h2 id="current-section-title" class="text-xl font-semibold mr-4">لوحة المعلومات</h2>
                </div>
                <div class="flex items-center">
                    <div class="relative">
                        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-moon dark:hidden"></i>
                            <i class="fas fa-sun hidden dark:block"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="p-6 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-primary bg-opacity-10 ml-4">
                                <i class="fas fa-users text-primary text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 dark:text-gray-400">إجمالي الموظفين</p>
                                <p class="text-2xl font-bold" id="total-employees">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-500 bg-opacity-10 ml-4">
                                <i class="fas fa-user-plus text-green-500 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 dark:text-gray-400">الموظفين الجدد</p>
                                <p class="text-2xl font-bold" id="new-employees-count">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-500 bg-opacity-10 ml-4">
                                <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 dark:text-gray-400">عقود تنتهي قريباً</p>
                                <p class="text-2xl font-bold" id="expiring-contracts">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-500 bg-opacity-10 ml-4">
                                <i class="fas fa-user-slash text-red-500 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 dark:text-gray-400">الموظفين المنتهين</p>
                                <p class="text-2xl font-bold" id="terminated-employees">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-xl font-semibold mb-4">الموظفين الجدد</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الرقم</th>
                                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الاسم</th>
                                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">المسمى الوظيفي</th>
                                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ التعيين</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="new-employees-table">
                                    <tr>
                                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="4">لا يوجد موظفين جدد</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-xl font-semibold mb-4">العقود التي تنتهي قريباً</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الموظف</th>
                                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">النوع</th>
                                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ الانتهاء</th>
                                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الأيام المتبقية</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="expiring-items-table">
                                    <tr>
                                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="4">لا يوجد عقود تنتهي قريباً</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Employees Section -->
            <section id="employees-section" class="p-6 hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-xl font-semibold mb-4 md:mb-0">قائمة الموظفين</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 md:space-x-reverse">
                            <button id="add-employee-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150 flex items-center justify-center">
                                <i class="fas fa-plus ml-2"></i>
                                <span>إضافة موظف</span>
                            </button>
                            <button id="toggle-advanced-search" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors duration-150 flex items-center justify-center">
                                <i class="fas fa-search ml-2"></i>
                                <span>بحث متقدم</span>
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Search Panel -->
                    <div id="advanced-search-panel" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="search-id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">رقم الموظف</label>
                                <input type="text" id="search-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                            </div>
                            <div>
                                <label for="search-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">الاسم</label>
                                <input type="text" id="search-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                            </div>
                            <div>
                                <label for="search-gender" class="block text-sm font-medium text-gray-700 dark:text-gray-300">الجنس</label>
                                <select id="search-gender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                    <option value="">الكل</option>
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                            </div>
                            <div>
                                <label for="search-position" class="block text-sm font-medium text-gray-700 dark:text-gray-300">المسمى الوظيفي</label>
                                <input type="text" id="search-position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                            </div>
                            <div>
                                <label for="search-department" class="block text-sm font-medium text-gray-700 dark:text-gray-300">القسم</label>
                                <select id="search-department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                    <option value="">جميع الأقسام</option>
                                    <option value="الإدارة">الإدارة</option>
                                    <option value="الموارد البشرية">الموارد البشرية</option>
                                    <option value="تكنولوجيا المعلومات">تكنولوجيا المعلومات</option>
                                    <option value="المالية">المالية</option>
                                    <option value="المبيعات">المبيعات</option>
                                    <option value="التسويق">التسويق</option>
                                </select>
                            </div>
                            <div>
                                <label for="search-contract-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">نوع العقد</label>
                                <select id="search-contract-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                    <option value="">جميع العقود</option>
                                    <option value="دائم">دائم</option>
                                    <option value="مؤقت">مؤقت</option>
                                    <option value="بدوام جزئي">بدوام جزئي</option>
                                    <option value="تدريب">تدريب</option>
                                </select>
                            </div>
                            <div>
                                <label for="search-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">الحالة</label>
                                <select id="search-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                    <option value="">جميع الحالات</option>
                                    <option value="نشط">نشط</option>
                                    <option value="إجازة">إجازة</option>
                                    <option value="منتهي">منتهي</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="clear-search" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 px-4 py-2 rounded-lg ml-2 transition-colors duration-150">مسح</button>
                            <button id="apply-search" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150">تطبيق البحث</button>
                        </div>
                    </div>

                    <!-- Employees Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الرقم</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الاسم</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الجنس</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">المسمى الوظيفي</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">القسم</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ التعيين</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ انتهاء العقد</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="employees-table">
                                <tr>
                                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="9">لا يوجد موظفين مسجلين</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-700 dark:text-gray-300">
                            <span id="pagination-info">عرض 0-0 من 0</span>
                        </div>
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <button id="prev-page" class="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <span id="current-page" class="text-sm">1</span>
                            <span class="text-sm">من</span>
                            <span id="total-pages" class="text-sm">1</span>
                            <button id="next-page" class="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Contracts Section -->
            <section id="contracts-section" class="p-6 hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-xl font-semibold mb-4 md:mb-0">إدارة العقود</h3>
                        <div>
                            <button id="add-contract-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150 flex items-center justify-center">
                                <i class="fas fa-plus ml-2"></i>
                                <span>إضافة عقد جديد</span>
                            </button>
                        </div>
                    </div>

                    <!-- Contracts Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">رقم العقد</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الموظف</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">نوع العقد</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ البدء</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ الانتهاء</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ انتهاء الإخطار</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="contracts-table">
                                <tr>
                                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="8">لا يوجد عقود مسجلة</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Leave Section -->
            <section id="leave-section" class="p-6 hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-xl font-semibold mb-4 md:mb-0">إدارة الإجازات</h3>
                        <div>
                            <button id="add-leave-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150 flex items-center justify-center">
                                <i class="fas fa-plus ml-2"></i>
                                <span>إضافة إجازة</span>
                            </button>
                        </div>
                    </div>

                    <!-- Leave Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الموظف</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">نوع الإجازة</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ البدء</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ الانتهاء</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">عدد الأيام</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="leave-table">
                                <tr>
                                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="7">لا يوجد إجازات مسجلة</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Absence Section -->
            <section id="absence-section" class="p-6 hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-xl font-semibold mb-4 md:mb-0">حساب غياب الموظفين</h3>
                        <div>
                            <button id="add-absence-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150 flex items-center justify-center">
                                <i class="fas fa-plus ml-2"></i>
                                <span>تسجيل غياب</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="absence-month-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الشهر</label>
                            <select id="absence-month-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                <option value="">اختر الشهر</option>
                                <option value="01">يناير</option>
                                <option value="02">فبراير</option>
                                <option value="03">مارس</option>
                                <option value="04">أبريل</option>
                                <option value="05">مايو</option>
                                <option value="06">يونيو</option>
                                <option value="07">يوليو</option>
                                <option value="08">أغسطس</option>
                                <option value="09">سبتمبر</option>
                                <option value="10">أكتوبر</option>
                                <option value="11">نوفمبر</option>
                                <option value="12">ديسمبر</option>
                            </select>
                        </div>
                        <div>
                            <label for="absence-year-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">السنة</label>
                            <input type="number" id="absence-year-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" min="2020">
                        </div>
                        <div>
                            <label for="absence-employee-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الموظف</label>
                            <select id="absence-employee-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                <option value="">جميع الموظفين</option>
                            </select>
                        </div>
                    </div>

                    <!-- Absence Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الموظف</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">التاريخ</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">نوع الغياب</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">السبب</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="absence-table">
                                <tr>
                                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="5">لا يوجد حالات غياب مسجلة</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Absence Statistics -->
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <p class="text-sm text-gray-600 dark:text-gray-400">إجمالي الغيابات</p>
                            <p class="text-2xl font-bold" id="total-absences">0</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900 dark:bg-opacity-20 rounded-lg p-4">
                            <p class="text-sm text-red-600 dark:text-red-400">غيابات بدون عذر</p>
                            <p class="text-2xl font-bold text-red-600 dark:text-red-400" id="absence-without-excuse">0</p>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900 dark:bg-opacity-20 rounded-lg p-4">
                            <p class="text-sm text-yellow-600 dark:text-yellow-400">غيابات برخصة</p>
                            <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="absence-with-permission">0</p>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 rounded-lg p-4">
                            <p class="text-sm text-blue-600 dark:text-blue-400">تأخيرات</p>
                            <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="late-count">0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ex-Employees Section -->
            <section id="ex-employees-section" class="p-6 hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div class="flex items-center">
                            <h3 class="text-xl font-semibold">الموظفين المنتهين خدماتهم</h3>
                            <div class="help-tooltip mr-2">
                                <i class="fas fa-question-circle text-primary"></i>
                                <div class="tooltip-text">
                                    <h4 class="font-bold mb-2">الموظفين المنتهين خدماتهم:</h4>
                                    <ul class="text-right text-sm">
                                        <li class="mb-1">• الموظفين الذين تم إنهاء عقودهم</li>
                                        <li class="mb-1">• الموظفين الذين تم الاستغناء عن خدماتهم</li>
                                        <li class="mb-1">• الموظفين الذين قدموا استقالتهم</li>
                                        <li class="mb-1">• الموظفين المتقاعدين</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <button id="add-termination-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150 flex items-center justify-center">
                                <i class="fas fa-user-slash ml-2"></i>
                                <span>إنهاء خدمات موظف</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filter controls -->
                    <div class="mb-6">
                        <div class="flex flex-wrap gap-2">
                            <button class="termination-filter px-3 py-1 rounded-full bg-primary text-white text-sm transition-colors" data-filter="all">جميع الموظفين المنتهين</button>
                            <button class="termination-filter px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-sm transition-colors" data-filter="إنهاء خدمات">إنهاء خدمات</button>
                            <button class="termination-filter px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-sm transition-colors" data-filter="استقالة">استقالة</button>
                            <button class="termination-filter px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-sm transition-colors" data-filter="انتهاء عقد">انتهاء عقد</button>
                            <button class="termination-filter px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-sm transition-colors" data-filter="تقاعد">تقاعد</button>
                        </div>
                    </div>

                    <!-- Ex-Employees Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">رقم الموظف</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الاسم</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">المسمى الوظيفي</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">القسم</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ التعيين</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ انتهاء الخدمة</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">سبب الانتهاء</th>
                                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="ex-employees-table">
                                <tr>
                                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="8">لا يوجد موظفين منتهين</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Import/Export Section -->
            <section id="import-export-section" class="p-6 hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-xl font-semibold mb-6">استيراد بيانات الموظفين</h3>
                        <div class="mb-6">
                            <label for="import-file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ملف الإكسل</label>
                            <div class="flex items-center">
                                <input type="file" id="import-file" accept=".xlsx, .xls" class="hidden">
                                <button id="select-file-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors duration-150 ml-2">اختر الملف</button>
                                <span id="file-name" class="text-gray-600 dark:text-gray-400">لم يتم اختيار ملف</span>
                            </div>
                        </div>
                        <div class="mb-6">
                            <h4 class="text-lg font-medium mb-2">تنسيق الملف المطلوب:</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">يجب أن يحتوي ملف الإكسل على الأعمدة التالية:</p>
                            <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-sm mt-2">
                                <li>رقم الموظف (مطلوب)</li>
                                <li>الاسم (مطلوب)</li>
                                <li>الجنس (مطلوب)</li>
                                <li>المسمى الوظيفي (مطلوب)</li>
                                <li>البريد الإلكتروني</li>
                                <li>رقم الهاتف</li>
                                <li>تاريخ التعيين (بصيغة YYYY-MM-DD)</li>
                                <li>تاريخ انتهاء العقد (بصيغة YYYY-MM-DD)</li>
                                <li>تاريخ انتهاء إخطار التعيين (بصيغة YYYY-MM-DD)</li>
                                <li>القسم</li>
                                <li>نوع العقد</li>
                            </ul>
                        </div>
                        <div class="flex justify-end">
                            <button id="download-template-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors duration-150 ml-2">تحميل قالب</button>
                            <button id="import-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed" disabled>استيراد البيانات</button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-xl font-semibold mb-6">تصدير بيانات الموظفين</h3>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">خيارات التصدير</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="export-all" class="ml-2" checked>
                                    <label for="export-all" class="text-gray-700 dark:text-gray-300">تصدير جميع البيانات</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="export-active-only" class="ml-2">
                                    <label for="export-active-only" class="text-gray-700 dark:text-gray-300">تصدير الموظفين النشطين فقط</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="export-contracts" class="ml-2">
                                    <label for="export-contracts" class="text-gray-700 dark:text-gray-300">تضمين بيانات العقود</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="export-terminated" class="ml-2">
                                    <label for="export-terminated" class="text-gray-700 dark:text-gray-300">تصدير الموظفين المنتهين</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="export-format" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">صيغة الملف</label>
                            <select id="export-format" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                            </select>
                        </div>
                        <div class="flex justify-end">
                            <button id="export-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150">تصدير البيانات</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" class="p-6 hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-6">تقارير الموظفين</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-medium mb-4">تقرير موظف واحد</h4>
                            <div class="mb-4">
                                <label for="report-employee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">اختر الموظف</label>
                                <select id="report-employee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                    <option value="">اختر موظف...</option>
                                </select>
                            </div>
                            <button id="generate-employee-report" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150">إنشاء التقرير</button>
                        </div>
                        
                        <div>
                            <h4 class="font-medium mb-4">تقرير جميع الموظفين</h4>
                            <div class="mb-4">
                                <label for="report-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نوع التقرير</label>
                                <select id="report-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                    <option value="all">جميع الموظفين</option>
                                    <option value="active">الموظفين النشطين</option>
                                    <option value="expiring">الموظفين قرب انتهاء عقودهم</option>
                                    <option value="new">الموظفين الجدد</option>
                                    <option value="terminated">الموظفين المنتهين</option>
                                </select>
                            </div>
                            <button id="generate-all-report" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150">إنشاء التقرير</button>
                        </div>
                    </div>
                    
                    <div id="report-result" class="hidden mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h4 id="report-title" class="text-lg font-medium">عنوان التقرير</h4>
                            <button id="export-report" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors duration-150 flex items-center">
                                <i class="fas fa-file-excel ml-2"></i>
                                <span>تصدير كملف Excel</span>
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead id="report-table-head">
                                    <!-- Header will be dynamically populated -->
                                </thead>
                                <tbody id="report-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Table content will be dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <!-- Employee Modal -->
    <div id="employee-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" id="employee-modal-title">إضافة موظف جديد</h3>
                    <button id="close-employee-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="employee-form">
                    <input type="hidden" id="employee-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="emp-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">رقم الموظف*</label>
                            <input type="text" id="emp-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div>
                            <label for="emp-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">اسم الموظف*</label>
                            <input type="text" id="emp-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div>
                            <label for="emp-gender" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الجنس*</label>
                            <select id="emp-gender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر الجنس</option>
                                <option value="ذكر">ذكر</option>
                                <option value="أنثى">أنثى</option>
                            </select>
                        </div>
                        <div>
                            <label for="emp-position" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">المسمى الوظيفي*</label>
                            <input type="text" id="emp-position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div>
                            <label for="emp-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">البريد الإلكتروني</label>
                            <input type="email" id="emp-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div>
                            <label for="emp-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">رقم الهاتف</label>
                            <input type="tel" id="emp-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div>
                            <label for="emp-department" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">القسم</label>
                            <select id="emp-department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                <option value="">اختر القسم</option>
                                <option value="الإدارة">الإدارة</option>
                                <option value="الموارد البشرية">الموارد البشرية</option>
                                <option value="تكنولوجيا المعلومات">تكنولوجيا المعلومات</option>
                                <option value="المالية">المالية</option>
                                <option value="المبيعات">المبيعات</option>
                                <option value="التسويق">التسويق</option>
                            </select>
                        </div>
                        <div>
                            <label for="emp-hire-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ التعيين</label>
                            <input type="date" id="emp-hire-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div>
                            <label for="emp-contract-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ انتهاء العقد</label>
                            <input type="date" id="emp-contract-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div>
                            <label for="emp-notice-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ انتهاء إخطار التعيين</label>
                            <input type="date" id="emp-notice-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div>
                            <label for="emp-contract-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نوع العقد</label>
                            <select id="emp-contract-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                <option value="">اختر نوع العقد</option>
                                <option value="دائم">دائم</option>
                                <option value="مؤقت">مؤقت</option>
                                <option value="بدوام جزئي">بدوام جزئي</option>
                                <option value="تدريب">تدريب</option>
                            </select>
                        </div>
                        <div>
                            <label for="emp-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الحالة</label>
                            <select id="emp-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                <option value="نشط">نشط</option>
                                <option value="إجازة">إجازة</option>
                                <option value="منتهي">منتهي</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="button" id="cancel-employee" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg ml-2 transition-colors duration-150">إلغاء</button>
                        <button type="submit" id="save-employee" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150">حفظ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Contract Modal -->
    <div id="contract-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" id="contract-modal-title">إضافة عقد جديد</h3>
                    <button id="close-contract-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="contract-form">
                    <input type="hidden" id="contract-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="contract-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">رقم العقد*</label>
                            <input type="text" id="contract-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div>
                            <label for="contract-employee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الموظف*</label>
                            <select id="contract-employee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر الموظف</option>
                            </select>
                        </div>
                        <div>
                            <label for="contract-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نوع العقد*</label>
                            <select id="contract-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر نوع العقد</option>
                                <option value="دائم">دائم</option>
                                <option value="مؤقت">مؤقت</option>
                                <option value="بدوام جزئي">بدوام جزئي</option>
                                <option value="تدريب">تدريب</option>
                            </select>
                        </div>
                        <div>
                            <label for="contract-salary" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الراتب</label>
                            <input type="number" id="contract-salary" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div>
                            <label for="contract-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ البدء*</label>
                            <input type="date" id="contract-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div>
                            <label for="contract-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ الانتهاء</label>
                            <input type="date" id="contract-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div>
                            <label for="contract-notice-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ انتهاء الإخطار</label>
                            <input type="date" id="contract-notice-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div class="md:col-span-2">
                            <label for="contract-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ملاحظات</label>
                            <textarea id="contract-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="button" id="cancel-contract" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg ml-2 transition-colors duration-150">إلغاء</button>
                        <button type="submit" id="save-contract" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150">حفظ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div id="leave-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" id="leave-modal-title">إضافة إجازة</h3>
                    <button id="close-leave-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="leave-form">
                    <input type="hidden" id="leave-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="leave-employee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الموظف*</label>
                            <select id="leave-employee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر الموظف</option>
                            </select>
                        </div>
                        <div>
                            <label for="leave-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نوع الإجازة*</label>
                            <select id="leave-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر النوع</option>
                                <option value="إجازة سنوية">إجازة سنوية</option>
                                <option value="إجازة مرضية">إجازة مرضية</option>
                                <option value="إجازة استثنائية">إجازة استثنائية</option>
                                <option value="إجازة بدون راتب">إجازة بدون راتب</option>
                                <option value="إجازة أمومة">إجازة أمومة</option>
                                <option value="إجازة أبوة">إجازة أبوة</option>
                            </select>
                        </div>
                        <div>
                            <label for="leave-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ البدء*</label>
                            <input type="date" id="leave-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div>
                            <label for="leave-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ الانتهاء*</label>
                            <input type="date" id="leave-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div>
                            <label for="leave-days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">عدد الأيام</label>
                            <input type="number" id="leave-days" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" readonly>
                        </div>
                        <div>
                            <label for="leave-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الحالة</label>
                            <select id="leave-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                <option value="موافق عليه">موافق عليه</option>
                                <option value="قيد الانتظار">قيد الانتظار</option>
                                <option value="مرفوض">مرفوض</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="leave-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ملاحظات</label>
                            <textarea id="leave-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="button" id="cancel-leave" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg ml-2 transition-colors duration-150">إلغاء</button>
                        <button type="submit" id="save-leave" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150">حفظ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Absence Modal -->
    <div id="absence-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" id="absence-modal-title">تسجيل غياب</h3>
                    <button id="close-absence-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="absence-form">
                    <input type="hidden" id="absence-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="absence-employee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الموظف*</label>
                            <select id="absence-employee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر الموظف</option>
                            </select>
                        </div>
                        <div>
                            <label for="absence-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">التاريخ*</label>
                            <input type="date" id="absence-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div>
                            <label for="absence-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نوع الغياب*</label>
                            <select id="absence-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر النوع</option>
                                <option value="غياب كامل">غياب كامل</option>
                                <option value="غياب جزئي">غياب جزئي</option>
                                <option value="تأخير">تأخير</option>
                            </select>
                        </div>
                        <div>
                            <label for="absence-hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">عدد الساعات (للغياب الجزئي)</label>
                            <input type="number" id="absence-hours" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" min="0" step="0.5">
                        </div>
                        <div>
                            <label for="absence-reason" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">السبب*</label>
                            <select id="absence-reason" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر السبب</option>
                                <option value="بدون عذر">بدون عذر</option>
                                <option value="برخصة">برخصة</option>
                                <option value="مرضي">مرضي</option>
                                <option value="أسباب طارئة">أسباب طارئة</option>
                            </select>
                        </div>
                        <div>
                            <label for="absence-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الحالة</label>
                            <select id="absence-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                                <option value="موثق">موثق</option>
                                <option value="قيد الاستكمال">قيد الاستكمال</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="absence-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ملاحظات</label>
                            <textarea id="absence-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="button" id="cancel-absence" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg ml-2 transition-colors duration-150">إلغاء</button>
                        <button type="submit" id="save-absence" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors duration-150">حفظ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Termination Modal -->
    <div id="termination-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" id="termination-modal-title">إنهاء خدمات موظف</h3>
                    <button id="close-termination-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="termination-form">
                    <input type="hidden" id="termination-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="termination-employee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الموظف*</label>
                            <select id="termination-employee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر الموظف</option>
                            </select>
                        </div>
                        <div>
                            <label for="termination-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">سبب الانتهاء*</label>
                            <select id="termination-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                                <option value="">اختر السبب</option>
                                <option value="إنهاء خدمات">إنهاء خدمات</option>
                                <option value="استقالة">استقالة</option>
                                <option value="انتهاء عقد">انتهاء عقد</option>
                                <option value="تقاعد">تقاعد</option>
                                <option value="آخر">سبب آخر</option>
                            </select>
                        </div>
                        <div>
                            <label for="termination-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاريخ انتهاء الخدمة*</label>
                            <input type="date" id="termination-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" required>
                        </div>
                        <div id="other-reason-container" class="hidden">
                            <label for="termination-other-reason" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">السبب*</label>
                            <input type="text" id="termination-other-reason" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base">
                        </div>
                        <div class="md:col-span-2">
                            <label for="termination-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ملاحظات</label>
                            <textarea id="termination-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="button" id="cancel-termination" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg ml-2 transition-colors duration-150">إلغاء</button>
                        <button type="submit" id="save-termination" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-150">إنهاء الخدمة</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" id="confirm-title">تأكيد الحذف</h3>
                    <button id="close-confirm-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p id="confirm-message" class="text-gray-700 dark:text-gray-300 mb-6">هل أنت متأكد من رغبتك في حذف هذا العنصر؟</p>
                <div class="flex justify-end">
                    <button id="confirm-cancel" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg ml-2 transition-colors duration-150">إلغاء</button>
                    <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-150">نعم، حذف</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 left-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-20 opacity-0 flex items-center">
        <i id="toast-icon" class="fas fa-check-circle ml-3 text-green-400"></i>
        <span id="toast-message">تمت العملية بنجاح</span>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Firebase Configuration and Data Management
        let db;
        let employees = [];
        let contracts = [];
        let terminations = [];
        let leaves = [];
        let absences = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredEmployees = [];
        let currentTerminationFilter = 'all';

        // Firebase Configuration (تكوين Firebase)
        const firebaseConfig = {
            apiKey: "AIzaSyCmXJBjuYHVwSFQ6izxvXEIIiaBowhvPf8",
            authDomain: "employers-f1326.firebaseapp.com",
            databaseURL: "https://employers-f1326-default-rtdb.firebaseio.com",
            projectId: "employers-f1326",
            storageBucket: "employers-f1326.firebasestorage.app",
            messagingSenderId: "501034702719",
            appId: "1:501034702719:web:7316eb8e8deac9903bec4a",
            measurementId: "G-4L827WK69V"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();

        // DOM Elements
        const themeToggle = document.getElementById('theme-toggle');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('#sidebar');
        const mainContent = document.querySelector('#main-content');
        const currentSectionTitle = document.getElementById('current-section-title');
        const loadingOverlay = document.getElementById('loading-overlay');
        const sections = {
            dashboard: document.getElementById('dashboard-section'),
            employees: document.getElementById('employees-section'),
            contracts: document.getElementById('contracts-section'),
            leave: document.getElementById('leave-section'),
            absence: document.getElementById('absence-section'),
            'ex-employees': document.getElementById('ex-employees-section'),
            'import-export': document.getElementById('import-export-section'),
            reports: document.getElementById('reports-section')
        };

        // Date formatting helper
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // Loading state helpers
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Toggle theme
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });

        // Toggle sidebar on mobile
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            
            if (sidebar.classList.contains('open')) {
                document.body.classList.add('sidebar-open');
            } else {
                document.body.classList.remove('sidebar-open');
            }
        });

        // Navigation
        function showSection(sectionId) {
            Object.values(sections).forEach(section => {
                section.classList.add('hidden');
            });
            
            document.querySelectorAll('[id^="nav-"]').forEach(navItem => {
                navItem.classList.remove('text-primary');
            });
            
            sections[sectionId].classList.remove('hidden');
            document.getElementById(`nav-${sectionId}`).classList.add('text-primary');
            
            const titles = {
                dashboard: 'لوحة المعلومات',
                employees: 'الموظفين',
                contracts: 'العقود',
                leave: 'الإجازات',
                absence: 'غياب الموظفين',
                'ex-employees': 'الموظفين المنتهين',
                'import-export': 'استيراد/تصدير',
                reports: 'التقارير'
            };
            
            currentSectionTitle.textContent = titles[sectionId];
            
            // Close sidebar on mobile after selection
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
                document.body.classList.remove('sidebar-open');
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toast.classList.remove('bg-red-800');
                toast.classList.add('bg-gray-800');
                toastIcon.classList.remove('fa-exclamation-circle', 'text-red-400');
                toastIcon.classList.add('fa-check-circle', 'text-green-400');
            } else {
                toast.classList.remove('bg-gray-800');
                toast.classList.add('bg-red-800');
                toastIcon.classList.remove('fa-check-circle', 'text-green-400');
                toastIcon.classList.add('fa-exclamation-circle', 'text-red-400');
            }
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Fetch all data from Firebase
        async function fetchAllData() {
            showLoading();
            
            try {
                // Fetch employees
                const employeesSnapshot = await db.collection('employees').get();
                employees = employeesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Fetch contracts
                const contractsSnapshot = await db.collection('contracts').get();
                contracts = contractsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Fetch terminations
                const terminationsSnapshot = await db.collection('terminations').get();
                terminations = terminationsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Fetch leaves
                const leavesSnapshot = await db.collection('leaves').get();
                leaves = leavesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Fetch absences
                const absencesSnapshot = await db.collection('absences').get();
                absences = absencesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Initialize filtered employees
                filteredEmployees = [...employees];
                
                // Update UI
                updateEmployeesList();
                updateContractsList();
                updateTerminationsList();
                updateLeavesList();
                updateAbsencesList();
                updateDashboard();
                updateReportEmployeeDropdown();
                updateTerminationEmployeeDropdown();
                updateLeaveEmployeeDropdown();
                updateAbsenceEmployeeDropdown();
                updateAbsenceEmployeeFilter();
                
                hideLoading();
            } catch (error) {
                console.error('Error fetching data:', error);
                showToast('حدث خطأ أثناء تحميل البيانات', 'error');
                hideLoading();
            }
        }

        // Listen for real-time updates
        function setupRealTimeListeners() {
            // Listen for employee changes
            db.collection('employees').onSnapshot(snapshot => {
                let dataChanged = false;
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const employeeData = {
                            id: change.doc.id,
                            ...change.doc.data()
                        };
                        
                        const index = employees.findIndex(e => e.id === employeeData.id);
                        
                        if (index === -1) {
                            employees.push(employeeData);
                        } else {
                            employees[index] = employeeData;
                        }
                        
                        dataChanged = true;
                    } else if (change.type === 'removed') {
                        const removedId = change.doc.id;
                        employees = employees.filter(e => e.id !== removedId);
                        dataChanged = true;
                    }
                });
                
                if (dataChanged) {
                    filteredEmployees = [...employees];
                    updateEmployeesList();
                    updateDashboard();
                    updateReportEmployeeDropdown();
                    updateTerminationEmployeeDropdown();
                    updateLeaveEmployeeDropdown();
                    updateAbsenceEmployeeDropdown();
                    updateAbsenceEmployeeFilter();
                }
            });

            // Listen for contract changes
            db.collection('contracts').onSnapshot(snapshot => {
                let dataChanged = false;
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const contractData = {
                            id: change.doc.id,
                            ...change.doc.data()
                        };
                        
                        const index = contracts.findIndex(c => c.id === contractData.id);
                        
                        if (index === -1) {
                            contracts.push(contractData);
                        } else {
                            contracts[index] = contractData;
                        }
                        
                        dataChanged = true;
                    } else if (change.type === 'removed') {
                        const removedId = change.doc.id;
                        contracts = contracts.filter(c => c.id !== removedId);
                        dataChanged = true;
                    }
                });
                
                if (dataChanged) {
                    updateContractsList();
                    updateDashboard();
                }
            });

            // Listen for termination changes
            db.collection('terminations').onSnapshot(snapshot => {
                let dataChanged = false;
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const terminationData = {
                            id: change.doc.id,
                            ...change.doc.data()
                        };
                        
                        const index = terminations.findIndex(t => t.id === terminationData.id);
                        
                        if (index === -1) {
                            terminations.push(terminationData);
                        } else {
                            terminations[index] = terminationData;
                        }
                        
                        dataChanged = true;
                    } else if (change.type === 'removed') {
                        const removedId = change.doc.id;
                        terminations = terminations.filter(t => t.id !== removedId);
                        dataChanged = true;
                    }
                });
                
                if (dataChanged) {
                    updateTerminationsList();
                    updateDashboard();
                }
            });

            // Listen for leave changes
            db.collection('leaves').onSnapshot(snapshot => {
                let dataChanged = false;
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const leaveData = {
                            id: change.doc.id,
                            ...change.doc.data()
                        };
                        
                        const index = leaves.findIndex(l => l.id === leaveData.id);
                        
                        if (index === -1) {
                            leaves.push(leaveData);
                        } else {
                            leaves[index] = leaveData;
                        }
                        
                        dataChanged = true;
                    } else if (change.type === 'removed') {
                        const removedId = change.doc.id;
                        leaves = leaves.filter(l => l.id !== removedId);
                        dataChanged = true;
                    }
                });
                
                if (dataChanged) {
                    updateLeavesList();
                }
            });

            // Listen for absence changes
            db.collection('absences').onSnapshot(snapshot => {
                let dataChanged = false;
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const absenceData = {
                            id: change.doc.id,
                            ...change.doc.data()
                        };
                        
                        const index = absences.findIndex(a => a.id === absenceData.id);
                        
                        if (index === -1) {
                            absences.push(absenceData);
                        } else {
                            absences[index] = absenceData;
                        }
                        
                        dataChanged = true;
                    } else if (change.type === 'removed') {
                        const removedId = change.doc.id;
                        absences = absences.filter(a => a.id !== removedId);
                        dataChanged = true;
                    }
                });
                
                if (dataChanged) {
                    updateAbsencesList();
                }
            });
        }

        // LEAVES SECTION
        document.getElementById('add-leave-btn').addEventListener('click', () => {
            document.getElementById('leave-modal-title').textContent = 'إضافة إجازة';
            document.getElementById('leave-form').reset();
            document.getElementById('leave-id').value = '';
            updateLeaveEmployeeDropdown();
            document.getElementById('leave-modal').classList.remove('hidden');
        });

        document.getElementById('close-leave-modal').addEventListener('click', () => {
            document.getElementById('leave-modal').classList.add('hidden');
        });

        document.getElementById('cancel-leave').addEventListener('click', () => {
            document.getElementById('leave-modal').classList.add('hidden');
        });

        // Calculate days automatically
        document.getElementById('leave-start-date').addEventListener('change', calculateLeaveDays);
        document.getElementById('leave-end-date').addEventListener('change', calculateLeaveDays);

        function calculateLeaveDays() {
            const startDate = new Date(document.getElementById('leave-start-date').value);
            const endDate = new Date(document.getElementById('leave-end-date').value);
            
            if (startDate && endDate) {
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('leave-days').value = diffDays;
            }
        }

        document.getElementById('leave-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            showLoading();
            
            const leaveId = document.getElementById('leave-id').value;
            const leave = {
                employeeId: document.getElementById('leave-employee').value,
                type: document.getElementById('leave-type').value,
                startDate: document.getElementById('leave-start-date').value,
                endDate: document.getElementById('leave-end-date').value,
                days: parseInt(document.getElementById('leave-days').value),
                status: document.getElementById('leave-status').value,
                notes: document.getElementById('leave-notes').value
            };
            
            try {
                if (leaveId) {
                    await db.collection('leaves').doc(leaveId).update(leave);
                    showToast('تم تحديث بيانات الإجازة بنجاح');
                } else {
                    await db.collection('leaves').add(leave);
                    showToast('تمت إضافة الإجازة بنجاح');
                }
                
                document.getElementById('leave-modal').classList.add('hidden');
            } catch (error) {
                console.error('Error saving leave:', error);
                showToast('حدث خطأ أثناء حفظ بيانات الإجازة', 'error');
            }
            
            hideLoading();
        });

        function updateLeavesList() {
            const tableBody = document.getElementById('leave-table');
            
            if (leaves.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="7">لا يوجد إجازات مسجلة</td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = '';
                
                leaves.forEach(leave => {
                    const employee = employees.find(emp => emp.id === leave.employeeId);
                    const employeeName = employee ? employee.name : 'غير معروف';
                    
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    
                    let statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    if (leave.status === 'قيد الانتظار') {
                        statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    } else if (leave.status === 'مرفوض') {
                        statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employeeName}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${leave.type || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${leave.startDate || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${leave.endDate || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${leave.days || 0}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${leave.status || ''}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-primary hover:text-secondary edit-leave" data-id="${leave.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-900 delete-leave" data-id="${leave.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                document.querySelectorAll('.edit-leave').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        editLeave(id);
                    });
                });
                
                document.querySelectorAll('.delete-leave').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        confirmDelete('leave', id);
                    });
                });
            }
        }

        function updateLeaveEmployeeDropdown() {
            const dropdown = document.getElementById('leave-employee');
            dropdown.innerHTML = '<option value="">اختر الموظف</option>';
            
            const activeEmployees = employees.filter(emp => emp.status === 'نشط');
            
            activeEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                dropdown.appendChild(option);
            });
        }

        function editLeave(id) {
            const leave = leaves.find(l => l.id === id);
            if (!leave) return;
            
            document.getElementById('leave-modal-title').textContent = 'تعديل بيانات الإجازة';
            document.getElementById('leave-id').value = leave.id;
            updateLeaveEmployeeDropdown();
            document.getElementById('leave-employee').value = leave.employeeId || '';
            document.getElementById('leave-type').value = leave.type || '';
            document.getElementById('leave-start-date').value = leave.startDate || '';
            document.getElementById('leave-end-date').value = leave.endDate || '';
            document.getElementById('leave-days').value = leave.days || '';
            document.getElementById('leave-status').value = leave.status || 'موافق عليه';
            document.getElementById('leave-notes').value = leave.notes || '';
            
            document.getElementById('leave-modal').classList.remove('hidden');
        }

        // ABSENCE SECTION
        document.getElementById('add-absence-btn').addEventListener('click', () => {
            document.getElementById('absence-modal-title').textContent = 'تسجيل غياب';
            document.getElementById('absence-form').reset();
            document.getElementById('absence-id').value = '';
            updateAbsenceEmployeeDropdown();
            document.getElementById('absence-modal').classList.remove('hidden');
        });

        document.getElementById('close-absence-modal').addEventListener('click', () => {
            document.getElementById('absence-modal').classList.add('hidden');
        });

        document.getElementById('cancel-absence').addEventListener('click', () => {
            document.getElementById('absence-modal').classList.add('hidden');
        });

        // Show/hide hours field based on absence type
        document.getElementById('absence-type').addEventListener('change', function() {
            const hoursField = document.getElementById('absence-hours').parentElement;
            
            if (this.value === 'غياب جزئي' || this.value === 'تأخير') {
                hoursField.classList.remove('hidden');
                document.getElementById('absence-hours').required = true;
            } else {
                hoursField.classList.add('hidden');
                document.getElementById('absence-hours').required = false;
            }
        });

        document.getElementById('absence-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            showLoading();
            
            const absenceId = document.getElementById('absence-id').value;
            const absence = {
                employeeId: document.getElementById('absence-employee').value,
                date: document.getElementById('absence-date').value,
                type: document.getElementById('absence-type').value,
                hours: parseFloat(document.getElementById('absence-hours').value) || 0,
                reason: document.getElementById('absence-reason').value,
                status: document.getElementById('absence-status').value,
                notes: document.getElementById('absence-notes').value
            };
            
            try {
                if (absenceId) {
                    await db.collection('absences').doc(absenceId).update(absence);
                    showToast('تم تحديث بيانات الغياب بنجاح');
                } else {
                    await db.collection('absences').add(absence);
                    showToast('تم تسجيل الغياب بنجاح');
                }
                
                document.getElementById('absence-modal').classList.add('hidden');
            } catch (error) {
                console.error('Error saving absence:', error);
                showToast('حدث خطأ أثناء حفظ بيانات الغياب', 'error');
            }
            
            hideLoading();
        });

        function updateAbsencesList() {
            const tableBody = document.getElementById('absence-table');
            
            // Get filter values
            const monthFilter = document.getElementById('absence-month-filter').value;
            const yearFilter = document.getElementById('absence-year-filter').value;
            const employeeFilter = document.getElementById('absence-employee-filter').value;
            
            let filteredAbsences = [...absences];
            
            if (monthFilter || yearFilter) {
                filteredAbsences = filteredAbsences.filter(absence => {
                    const absenceDate = new Date(absence.date);
                    const month = String(absenceDate.getMonth() + 1).padStart(2, '0');
                    const year = absenceDate.getFullYear().toString();
                    
                    if (monthFilter && month !== monthFilter) return false;
                    if (yearFilter && year !== yearFilter) return false;
                    
                    return true;
                });
            }
            
            if (employeeFilter) {
                filteredAbsences = filteredAbsences.filter(absence => absence.employeeId === employeeFilter);
            }
            
            if (filteredAbsences.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="5">لا يوجد حالات غياب مسجلة</td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = '';
                
                filteredAbsences.forEach(absence => {
                    const employee = employees.find(emp => emp.id === absence.employeeId);
                    const employeeName = employee ? employee.name : 'غير معروف';
                    
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employeeName}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${absence.date || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${absence.type || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${absence.reason || ''}</td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-primary hover:text-secondary edit-absence" data-id="${absence.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-900 delete-absence" data-id="${absence.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                document.querySelectorAll('.edit-absence').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        editAbsence(id);
                    });
                });
                
                document.querySelectorAll('.delete-absence').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        confirmDelete('absence', id);
                    });
                });
            }
            
            updateAbsenceStatistics(filteredAbsences);
        }

        function updateAbsenceEmployeeDropdown() {
            const dropdown = document.getElementById('absence-employee');
            dropdown.innerHTML = '<option value="">اختر الموظف</option>';
            
            const activeEmployees = employees.filter(emp => emp.status === 'نشط');
            
            activeEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                dropdown.appendChild(option);
            });
        }

        function updateAbsenceEmployeeFilter() {
            const dropdown = document.getElementById('absence-employee-filter');
            const currentValue = dropdown.value;
            dropdown.innerHTML = '<option value="">جميع الموظفين</option>';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                dropdown.appendChild(option);
            });
            
            dropdown.value = currentValue;
        }

        function editAbsence(id) {
            const absence = absences.find(a => a.id === id);
            if (!absence) return;
            
            document.getElementById('absence-modal-title').textContent = 'تعديل بيانات الغياب';
            document.getElementById('absence-id').value = absence.id;
            updateAbsenceEmployeeDropdown();
            document.getElementById('absence-employee').value = absence.employeeId || '';
            document.getElementById('absence-date').value = absence.date || '';
            document.getElementById('absence-type').value = absence.type || '';
            document.getElementById('absence-hours').value = absence.hours || '';
            document.getElementById('absence-reason').value = absence.reason || '';
            document.getElementById('absence-status').value = absence.status || 'موثق';
            document.getElementById('absence-notes').value = absence.notes || '';
            
            // Trigger type change to show/hide hours field
            document.getElementById('absence-type').dispatchEvent(new Event('change'));
            
            document.getElementById('absence-modal').classList.remove('hidden');
        }

        function updateAbsenceStatistics(filteredAbsences) {
            let totalAbsences = filteredAbsences.length;
            let withoutExcuse = 0;
            let withPermission = 0;
            let lateCount = 0;
            
            filteredAbsences.forEach(absence => {
                if (absence.type === 'تأخير') {
                    lateCount++;
                } else if (absence.reason === 'بدون عذر') {
                    withoutExcuse++;
                } else if (absence.reason === 'برخصة') {
                    withPermission++;
                }
            });
            
            document.getElementById('total-absences').textContent = totalAbsences;
            document.getElementById('absence-without-excuse').textContent = withoutExcuse;
            document.getElementById('absence-with-permission').textContent = withPermission;
            document.getElementById('late-count').textContent = lateCount;
        }

        // Filter absences by month and year
        document.getElementById('absence-month-filter').addEventListener('change', () => updateAbsencesList());
        document.getElementById('absence-year-filter').addEventListener('change', () => updateAbsencesList());
        document.getElementById('absence-employee-filter').addEventListener('change', () => updateAbsencesList());

        // REMAINING CODE (employees, contracts, terminations, etc. - same as before)
        // Add employee button
        document.getElementById('add-employee-btn').addEventListener('click', () => {
            document.getElementById('employee-modal-title').textContent = 'إضافة موظف جديد';
            document.getElementById('employee-form').reset();
            document.getElementById('employee-id').value = '';
            document.getElementById('employee-modal').classList.remove('hidden');
        });

        // Close employee modal
        document.getElementById('close-employee-modal').addEventListener('click', () => {
            document.getElementById('employee-modal').classList.add('hidden');
        });

        document.getElementById('cancel-employee').addEventListener('click', () => {
            document.getElementById('employee-modal').classList.add('hidden');
        });

        // Save employee
        document.getElementById('employee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            showLoading();
            
            const employeeId = document.getElementById('employee-id').value;
            const employee = {
                number: document.getElementById('emp-number').value,
                name: document.getElementById('emp-name').value,
                gender: document.getElementById('emp-gender').value,
                position: document.getElementById('emp-position').value,
                department: document.getElementById('emp-department').value,
                email: document.getElementById('emp-email').value,
                phone: document.getElementById('emp-phone').value,
                hireDate: document.getElementById('emp-hire-date').value,
                contractEndDate: document.getElementById('emp-contract-end-date').value,
                noticeEndDate: document.getElementById('emp-notice-end-date').value,
                contractType: document.getElementById('emp-contract-type').value,
                status: document.getElementById('emp-status').value
            };
            
            try {
                if (employeeId) {
                    // Update existing employee
                    await db.collection('employees').doc(employeeId).update(employee);
                    showToast('تم تحديث بيانات الموظف بنجاح');
                } else {
                    // Add new employee
                    await db.collection('employees').add(employee);
                    showToast('تمت إضافة الموظف بنجاح');
                }
                
                document.getElementById('employee-modal').classList.add('hidden');
            } catch (error) {
                console.error('Error saving employee:', error);
                showToast('حدث خطأ أثناء حفظ بيانات الموظف', 'error');
            }
            
            hideLoading();
        });

        // Toggle advanced search panel
        document.getElementById('toggle-advanced-search').addEventListener('click', () => {
            const searchPanel = document.getElementById('advanced-search-panel');
            searchPanel.classList.toggle('hidden');
        });

        // Apply search filters
        document.getElementById('apply-search').addEventListener('click', () => {
            applyFilters();
        });

        // Clear search filters
        document.getElementById('clear-search').addEventListener('click', () => {
            document.getElementById('search-id').value = '';
            document.getElementById('search-name').value = '';
            document.getElementById('search-gender').value = '';
            document.getElementById('search-position').value = '';
            document.getElementById('search-department').value = '';
            document.getElementById('search-contract-type').value = '';
            document.getElementById('search-status').value = '';
            applyFilters();
        });

        // Apply filters to employees list
        function applyFilters() {
            const searchId = document.getElementById('search-id').value.toLowerCase();
            const searchName = document.getElementById('search-name').value.toLowerCase();
            const searchGender = document.getElementById('search-gender').value;
            const searchPosition = document.getElementById('search-position').value.toLowerCase();
            const searchDepartment = document.getElementById('search-department').value;
            const searchContractType = document.getElementById('search-contract-type').value;
            const searchStatus = document.getElementById('search-status').value;
            
            filteredEmployees = employees.filter(employee => {
                return (
                    (searchId === '' || (employee.number && employee.number.toLowerCase().includes(searchId))) &&
                    (searchName === '' || (employee.name && employee.name.toLowerCase().includes(searchName))) &&
                    (searchGender === '' || employee.gender === searchGender) &&
                    (searchPosition === '' || (employee.position && employee.position.toLowerCase().includes(searchPosition))) &&
                    (searchDepartment === '' || employee.department === searchDepartment) &&
                    (searchContractType === '' || employee.contractType === searchContractType) &&
                    (searchStatus === '' || employee.status === searchStatus)
                );
            });
            
            currentPage = 1;
            updateEmployeesList();
        }

        // Update employees table
        function updateEmployeesList() {
            const tableBody = document.getElementById('employees-table');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedEmployees = filteredEmployees.slice(start, end);
            
            if (filteredEmployees.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="9">لا يوجد موظفين مسجلين</td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = '';
                
                paginatedEmployees.forEach(employee => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.number || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.name || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.gender || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.position || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.department || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.hireDate || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.contractEndDate || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${employee.status === 'نشط' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : employee.status === 'إجازة' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                ${employee.status || ''}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-primary hover:text-secondary edit-employee" data-id="${employee.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-900 delete-employee" data-id="${employee.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-employee').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        editEmployee(id);
                    });
                });
                
                document.querySelectorAll('.delete-employee').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        confirmDelete('employee', id);
                    });
                });
            }
            
            // Update pagination
            updateEmployeePagination();
        }

        // Update pagination for employees
        function updateEmployeePagination() {
            const totalPages = Math.ceil(filteredEmployees.length / itemsPerPage);
            const paginationInfo = document.getElementById('pagination-info');
            const currentPageElem = document.getElementById('current-page');
            const totalPagesElem = document.getElementById('total-pages');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            const start = filteredEmployees.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
            const end = Math.min(start + itemsPerPage - 1, filteredEmployees.length);
            
            paginationInfo.textContent = `عرض ${start}-${end} من ${filteredEmployees.length}`;
            currentPageElem.textContent = currentPage;
            totalPagesElem.textContent = totalPages;
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            // Remove existing event listeners by cloning and replacing elements
            const newPrevBtn = prevBtn.cloneNode(true);
            const newNextBtn = nextBtn.cloneNode(true);
            prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
            nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
            
            // Add new event listeners
            newPrevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateEmployeesList();
                }
            });
            
            newNextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateEmployeesList();
                }
            });
        }

        // Edit employee
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            document.getElementById('employee-modal-title').textContent = 'تعديل بيانات الموظف';
            document.getElementById('employee-id').value = employee.id;
            document.getElementById('emp-number').value = employee.number || '';
            document.getElementById('emp-name').value = employee.name || '';
            document.getElementById('emp-gender').value = employee.gender || '';
            document.getElementById('emp-position').value = employee.position || '';
            document.getElementById('emp-department').value = employee.department || '';
            document.getElementById('emp-email').value = employee.email || '';
            document.getElementById('emp-phone').value = employee.phone || '';
            document.getElementById('emp-hire-date').value = employee.hireDate || '';
            document.getElementById('emp-contract-end-date').value = employee.contractEndDate || '';
            document.getElementById('emp-notice-end-date').value = employee.noticeEndDate || '';
            document.getElementById('emp-contract-type').value = employee.contractType || '';
            document.getElementById('emp-status').value = employee.status || 'نشط';
            
            document.getElementById('employee-modal').classList.remove('hidden');
        }

        // Delete confirmation
        function confirmDelete(type, id) {
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmYes = document.getElementById('confirm-yes');
            
            if (type === 'employee') {
                const employee = employees.find(emp => emp.id === id);
                confirmTitle.textContent = 'تأكيد حذف الموظف';
                confirmMessage.textContent = `هل أنت متأكد من رغبتك في حذف الموظف "${employee.name}"؟`;
                
                confirmYes.onclick = async () => {
                    showLoading();
                    
                    try {
                        // Delete employee from Firebase
                        await db.collection('employees').doc(id).delete();
                        
                        // Delete related contracts
                        const contractsToDelete = contracts.filter(contract => contract.employeeId === id);
                        for (const contract of contractsToDelete) {
                            await db.collection('contracts').doc(contract.id).delete();
                        }
                        
                        // Delete related terminations
                        const terminationsToDelete = terminations.filter(termination => termination.employeeId === id);
                        for (const termination of terminationsToDelete) {
                            await db.collection('terminations').doc(termination.id).delete();
                        }
                        
                        // Delete related leaves
                        const leavesToDelete = leaves.filter(leave => leave.employeeId === id);
                        for (const leave of leavesToDelete) {
                            await db.collection('leaves').doc(leave.id).delete();
                        }
                        
                        // Delete related absences
                        const absencesToDelete = absences.filter(absence => absence.employeeId === id);
                        for (const absence of absencesToDelete) {
                            await db.collection('absences').doc(absence.id).delete();
                        }
                        
                        confirmModal.classList.add('hidden');
                        showToast('تم حذف الموظف بنجاح');
                    } catch (error) {
                        console.error('Error deleting employee:', error);
                        showToast('حدث خطأ أثناء حذف الموظف', 'error');
                    }
                    
                    hideLoading();
                };
            } else if (type === 'contract') {
                const contract = contracts.find(c => c.id === id);
                confirmTitle.textContent = 'تأكيد حذف العقد';
                confirmMessage.textContent = `هل أنت متأكد من رغبتك في حذف العقد رقم "${contract.number}"؟`;
                
                confirmYes.onclick = async () => {
                    showLoading();
                    
                    try {
                        // Delete contract from Firebase
                        await db.collection('contracts').doc(id).delete();
                        
                        confirmModal.classList.add('hidden');
                        showToast('تم حذف العقد بنجاح');
                    } catch (error) {
                        console.error('Error deleting contract:', error);
                        showToast('حدث خطأ أثناء حذف العقد', 'error');
                    }
                    
                    hideLoading();
                };
            } else if (type === 'termination') {
                const termination = terminations.find(t => t.id === id);
                const employee = employees.find(emp => emp.id === termination.employeeId);
                const employeeName = employee ? employee.name : 'غير معروف';
                
                confirmTitle.textContent = 'تأكيد حذف سجل انتهاء الخدمة';
                confirmMessage.textContent = `هل أنت متأكد من رغبتك في حذف سجل انتهاء خدمة "${employeeName}"؟`;
                
                confirmYes.onclick = async () => {
                    showLoading();
                    
                    try {
                        // Delete termination from Firebase
                        await db.collection('terminations').doc(id).delete();
                        
                        // Update employee status if needed
                        if (employee && employee.status === 'منتهي') {
                            await db.collection('employees').doc(employee.id).update({
                                status: 'نشط'
                            });
                        }
                        
                        confirmModal.classList.add('hidden');
                        showToast('تم حذف سجل انتهاء الخدمة بنجاح');
                    } catch (error) {
                        console.error('Error deleting termination:', error);
                        showToast('حدث خطأ أثناء حذف سجل انتهاء الخدمة', 'error');
                    }
                    
                    hideLoading();
                };
            } else if (type === 'leave') {
                const leave = leaves.find(l => l.id === id);
                const employee = employees.find(emp => emp.id === leave.employeeId);
                const employeeName = employee ? employee.name : 'غير معروف';
                
                confirmTitle.textContent = 'تأكيد حذف الإجازة';
                confirmMessage.textContent = `هل أنت متأكد من رغبتك في حذف إجازة "${employeeName}"؟`;
                
                confirmYes.onclick = async () => {
                    showLoading();
                    
                    try {
                        await db.collection('leaves').doc(id).delete();
                        confirmModal.classList.add('hidden');
                        showToast('تم حذف الإجازة بنجاح');
                    } catch (error) {
                        console.error('Error deleting leave:', error);
                        showToast('حدث خطأ أثناء حذف الإجازة', 'error');
                    }
                    
                    hideLoading();
                };
            } else if (type === 'absence') {
                const absence = absences.find(a => a.id === id);
                const employee = employees.find(emp => emp.id === absence.employeeId);
                const employeeName = employee ? employee.name : 'غير معروف';
                
                confirmTitle.textContent = 'تأكيد حذف الغياب';
                confirmMessage.textContent = `هل أنت متأكد من رغبتك في حذف سجل غياب "${employeeName}"؟`;
                
                confirmYes.onclick = async () => {
                    showLoading();
                    
                    try {
                        await db.collection('absences').doc(id).delete();
                        confirmModal.classList.add('hidden');
                        showToast('تم حذف سجل الغياب بنجاح');
                    } catch (error) {
                        console.error('Error deleting absence:', error);
                        showToast('حدث خطأ أثناء حذف سجل الغياب', 'error');
                    }
                    
                    hideLoading();
                };
            }
            
            confirmModal.classList.remove('hidden');
        }

        // Close confirm modal
        document.getElementById('close-confirm-modal').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.add('hidden');
        });

        document.getElementById('confirm-cancel').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.add('hidden');
        });

        // Add contract button
        document.getElementById('add-contract-btn').addEventListener('click', () => {
            document.getElementById('contract-modal-title').textContent = 'إضافة عقد جديد';
            document.getElementById('contract-form').reset();
            document.getElementById('contract-id').value = '';
            updateEmployeeDropdown();
            document.getElementById('contract-modal').classList.remove('hidden');
        });

        // Close contract modal
        document.getElementById('close-contract-modal').addEventListener('click', () => {
            document.getElementById('contract-modal').classList.add('hidden');
        });

        document.getElementById('cancel-contract').addEventListener('click', () => {
            document.getElementById('contract-modal').classList.add('hidden');
        });

        // Save contract
        document.getElementById('contract-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            showLoading();
            
            const contractId = document.getElementById('contract-id').value;
            const contract = {
                number: document.getElementById('contract-number').value,
                employeeId: document.getElementById('contract-employee').value,
                type: document.getElementById('contract-type').value,
                salary: document.getElementById('contract-salary').value,
                startDate: document.getElementById('contract-start-date').value,
                endDate: document.getElementById('contract-end-date').value,
                noticeEndDate: document.getElementById('contract-notice-end-date').value,
                notes: document.getElementById('contract-notes').value,
            };
            
            try {
                if (contractId) {
                    // Update existing contract
                    await db.collection('contracts').doc(contractId).update(contract);
                    showToast('تم تحديث بيانات العقد بنجاح');
                } else {
                    // Add new contract
                    await db.collection('contracts').add(contract);
                    showToast('تمت إضافة العقد بنجاح');
                }
                
                // Update employee contract information
                const employee = employees.find(emp => emp.id === contract.employeeId);
                if (employee) {
                    await db.collection('employees').doc(employee.id).update({
                        contractType: contract.type,
                        contractEndDate: contract.endDate,
                        noticeEndDate: contract.noticeEndDate
                    });
                }
                
                document.getElementById('contract-modal').classList.add('hidden');
            } catch (error) {
                console.error('Error saving contract:', error);
                showToast('حدث خطأ أثناء حفظ بيانات العقد', 'error');
            }
            
            hideLoading();
        });

        // Update contracts table
        function updateContractsList() {
            const tableBody = document.getElementById('contracts-table');
            
            if (contracts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="8">لا يوجد عقود مسجلة</td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = '';
                
                contracts.forEach(contract => {
                    // Get employee name
                    const employee = employees.find(emp => emp.id === contract.employeeId);
                    const employeeName = employee ? employee.name : 'غير معروف';
                    
                    // Calculate contract status
                    let status = 'نشط';
                    let statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    
                    if (contract.endDate) {
                        const today = new Date();
                        const endDate = new Date(contract.endDate);
                        
                        if (endDate < today) {
                            status = 'منتهي';
                            statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                        } else {
                            const daysLeft = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
                            
                            if (daysLeft <= 30) {
                                status = `ينتهي قريباً (${daysLeft} يوم)`;
                                statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                            }
                        }
                    } else if (contract.type === 'دائم') {
                        status = 'دائم';
                    }
                    
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${contract.number || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employeeName}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${contract.type || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${contract.startDate || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${contract.endDate || 'غير محدد'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${contract.noticeEndDate || 'غير محدد'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-primary hover:text-secondary edit-contract" data-id="${contract.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-900 delete-contract" data-id="${contract.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-contract').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        editContract(id);
                    });
                });
                
                document.querySelectorAll('.delete-contract').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        confirmDelete('contract', id);
                    });
                });
            }
        }

        // Update employee dropdown in contract form
        function updateEmployeeDropdown() {
            const dropdown = document.getElementById('contract-employee');
            dropdown.innerHTML = '<option value="">اختر الموظف</option>';
            
            // Only show active employees
            const activeEmployees = employees.filter(emp => emp.status === 'نشط');
            
            activeEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                dropdown.appendChild(option);
            });
        }

        // Edit contract
        function editContract(id) {
            const contract = contracts.find(c => c.id === id);
            if (!contract) return;
            
            document.getElementById('contract-modal-title').textContent = 'تعديل بيانات العقد';
            document.getElementById('contract-id').value = contract.id;
            document.getElementById('contract-number').value = contract.number || '';
            updateEmployeeDropdown();
            document.getElementById('contract-employee').value = contract.employeeId || '';
            document.getElementById('contract-type').value = contract.type || '';
            document.getElementById('contract-salary').value = contract.salary || '';
            document.getElementById('contract-start-date').value = contract.startDate || '';
            document.getElementById('contract-end-date').value = contract.endDate || '';
            document.getElementById('contract-notice-end-date').value = contract.noticeEndDate || '';
            document.getElementById('contract-notes').value = contract.notes || '';
            
            document.getElementById('contract-modal').classList.remove('hidden');
        }

        // Add termination button
        document.getElementById('add-termination-btn').addEventListener('click', () => {
            document.getElementById('termination-modal-title').textContent = 'إنهاء خدمات موظف';
            document.getElementById('termination-form').reset();
            document.getElementById('termination-id').value = '';
            document.getElementById('other-reason-container').classList.add('hidden');
            updateTerminationEmployeeDropdown();
            document.getElementById('termination-modal').classList.remove('hidden');
        });

        // Close termination modal
        document.getElementById('close-termination-modal').addEventListener('click', () => {
            document.getElementById('termination-modal').classList.add('hidden');
        });

        document.getElementById('cancel-termination').addEventListener('click', () => {
            document.getElementById('termination-modal').classList.add('hidden');
        });

        // Show/hide other reason field based on termination type
        document.getElementById('termination-type').addEventListener('change', function() {
            const otherReasonContainer = document.getElementById('other-reason-container');
            
            if (this.value === 'آخر') {
                otherReasonContainer.classList.remove('hidden');
                document.getElementById('termination-other-reason').required = true;
            } else {
                otherReasonContainer.classList.add('hidden');
                document.getElementById('termination-other-reason').required = false;
            }
        });

        // Save termination
        document.getElementById('termination-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            showLoading();
            
            const terminationId = document.getElementById('termination-id').value;
            const terminationTypeSelect = document.getElementById('termination-type');
            
            let terminationType = terminationTypeSelect.value;
            
            // If "other" is selected, use the custom reason
            if (terminationType === 'آخر') {
                terminationType = document.getElementById('termination-other-reason').value;
            }
            
            const termination = {
                employeeId: document.getElementById('termination-employee').value,
                terminationType: terminationType,
                terminationDate: document.getElementById('termination-date').value,
                notes: document.getElementById('termination-notes').value
            };
            
            try {
                if (terminationId) {
                    // Update existing termination
                    await db.collection('terminations').doc(terminationId).update(termination);
                    showToast('تم تحديث بيانات انتهاء الخدمة بنجاح');
                } else {
                    // Add new termination
                    await db.collection('terminations').add(termination);
                    showToast('تم تسجيل انتهاء الخدمة بنجاح');
                    
                    // Update employee status to "منتهي"
                    await db.collection('employees').doc(termination.employeeId).update({
                        status: 'منتهي'
                    });
                }
                
                document.getElementById('termination-modal').classList.add('hidden');
            } catch (error) {
                console.error('Error saving termination:', error);
                showToast('حدث خطأ أثناء حفظ بيانات انتهاء الخدمة', 'error');
            }
            
            hideLoading();
        });

        // Update employee dropdown in termination form
        function updateTerminationEmployeeDropdown() {
            const dropdown = document.getElementById('termination-employee');
            dropdown.innerHTML = '<option value="">اختر الموظف</option>';
            
            // Only show active employees
            const activeEmployees = employees.filter(emp => emp.status === 'نشط');
            
            activeEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                dropdown.appendChild(option);
            });
        }

        // Filter terminations
        document.querySelectorAll('.termination-filter').forEach(button => {
            button.addEventListener('click', (e) => {
                // Remove active class from all buttons
                document.querySelectorAll('.termination-filter').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                });
                
                // Add active class to the clicked button
                e.target.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                e.target.classList.add('bg-primary', 'text-white');
                
                // Get filter value
                currentTerminationFilter = e.target.getAttribute('data-filter');
                
                // Apply filter
                updateTerminationsList();
            });
        });

        // Update terminations list
        function updateTerminationsList() {
            const terminationsTable = document.getElementById('ex-employees-table');
            
            // Apply filter
            let filteredTerminations = [...terminations];
            
            if (currentTerminationFilter !== 'all') {
                filteredTerminations = filteredTerminations.filter(t => t.terminationType === currentTerminationFilter);
            }
            
            if (filteredTerminations.length === 0) {
                terminationsTable.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="8">لا يوجد موظفين منتهين</td>
                    </tr>
                `;
            } else {
                terminationsTable.innerHTML = '';
                
                // Sort terminations by date (newest first)
                filteredTerminations.sort((a, b) => new Date(b.terminationDate) - new Date(a.terminationDate));
                
                filteredTerminations.forEach(termination => {
                    const employee = employees.find(emp => emp.id === termination.employeeId);
                    
                    // Skip if employee not found (might have been deleted)
                    if (!employee) return;
                    
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    
                    let terminationTypeClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    
                    if (termination.terminationType === 'استقالة') {
                        terminationTypeClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                    } else if (termination.terminationType === 'انتهاء عقد') {
                        terminationTypeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    } else if (termination.terminationType === 'تقاعد') {
                        terminationTypeClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.number || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.name || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.position || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.department || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.hireDate || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${termination.terminationDate || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${terminationTypeClass}">
                                ${termination.terminationType}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-primary hover:text-secondary view-termination" data-id="${termination.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-900 delete-termination" data-id="${termination.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    terminationsTable.appendChild(row);
                });
                
                // Add event listeners to view and delete buttons
                document.querySelectorAll('.view-termination').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        viewTermination(id);
                    });
                });
                
                document.querySelectorAll('.delete-termination').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        confirmDelete('termination', id);
                    });
                });
            }
        }

        // View termination details
        function viewTermination(id) {
            const termination = terminations.find(t => t.id === id);
            if (!termination) return;
            
            const employee = employees.find(emp => emp.id === termination.employeeId);
            if (!employee) return;
            
            document.getElementById('termination-modal-title').textContent = 'تفاصيل انتهاء الخدمة';
            document.getElementById('termination-id').value = termination.id;
            
            // Update the employee dropdown
            updateTerminationEmployeeDropdown();
            
            // Set values
            document.getElementById('termination-employee').value = termination.employeeId;
            
            // Handle termination type
            const standardTypes = ['إنهاء خدمات', 'استقالة', 'انتهاء عقد', 'تقاعد'];
            if (standardTypes.includes(termination.terminationType)) {
                document.getElementById('termination-type').value = termination.terminationType;
                document.getElementById('other-reason-container').classList.add('hidden');
            } else {
                document.getElementById('termination-type').value = 'آخر';
                document.getElementById('termination-other-reason').value = termination.terminationType;
                document.getElementById('other-reason-container').classList.remove('hidden');
            }
            
            document.getElementById('termination-date').value = termination.terminationDate || '';
            document.getElementById('termination-notes').value = termination.notes || '';
            
            // Disable all form fields for viewing
            document.getElementById('termination-employee').disabled = true;
            document.getElementById('termination-type').disabled = true;
            document.getElementById('termination-other-reason').disabled = true;
            document.getElementById('termination-date').disabled = true;
            document.getElementById('termination-notes').disabled = true;
            
            // Hide submit button, rename cancel button
            document.getElementById('save-termination').classList.add('hidden');
            document.getElementById('cancel-termination').textContent = 'إغلاق';
            
            document.getElementById('termination-modal').classList.remove('hidden');
            
            // Reset form when closing
            document.getElementById('cancel-termination').addEventListener('click', () => {
                // Re-enable all fields and reset button text
                document.getElementById('termination-employee').disabled = false;
                document.getElementById('termination-type').disabled = false;
                document.getElementById('termination-other-reason').disabled = false;
                document.getElementById('termination-date').disabled = false;
                document.getElementById('termination-notes').disabled = false;
                
                document.getElementById('save-termination').classList.remove('hidden');
                document.getElementById('cancel-termination').textContent = 'إلغاء';
            }, { once: true });
        }

        // Update dropdown for reports section
        function updateReportEmployeeDropdown() {
            const dropdown = document.getElementById('report-employee');
            dropdown.innerHTML = '<option value="">اختر موظف...</option>';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                dropdown.appendChild(option);
            });
        }

        // File selection button
        document.getElementById('select-file-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });

        // Show selected file name
        document.getElementById('import-file').addEventListener('change', (e) => {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'لم يتم اختيار ملف';
            document.getElementById('file-name').textContent = fileName;
            
            // Enable import button if file is selected
            document.getElementById('import-btn').disabled = !e.target.files[0];
        });

        // Import data from Excel
        document.getElementById('import-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('import-file');
            
            if (!fileInput.files || !fileInput.files[0]) {
                showToast('الرجاء اختيار ملف أولاً', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false });
                        
                        if (jsonData.length === 0) {
                            showToast('الملف لا يحتوي على بيانات', 'error');
                            hideLoading();
                            return;
                        }
                        
                        // Verify the data structure
                        const requiredColumns = ['رقم الموظف', 'الاسم', 'الجنس', 'المسمى الوظيفي'];
                        const firstRow = jsonData[0];
                        
                        const missingColumns = requiredColumns.filter(column => !Object.keys(firstRow).includes(column));
                        
                        if (missingColumns.length > 0) {
                            showToast(`الملف يفتقد للأعمدة التالية: ${missingColumns.join(', ')}`, 'error');
                            hideLoading();
                            return;
                        }
                        
                        // Import the data
                        let importedCount = 0;
                        
                        for (const row of jsonData) {
                            const employee = {
                                number: row['رقم الموظف'],
                                name: row['الاسم'],
                                gender: row['الجنس'],
                                position: row['المسمى الوظيفي'],
                                email: row['البريد الإلكتروني'] || '',
                                phone: row['رقم الهاتف'] || '',
                                hireDate: row['تاريخ التعيين'] || '',
                                contractEndDate: row['تاريخ انتهاء العقد'] || '',
                                noticeEndDate: row['تاريخ انتهاء إخطار التعيين'] || '',
                                department: row['القسم'] || '',
                                contractType: row['نوع العقد'] || '',
                                status: 'نشط'
                            };
                            
                            // Check if employee already exists
                            const existingEmployee = employees.find(emp => emp.number === employee.number);
                            
                            if (existingEmployee) {
                                // Update existing employee
                                await db.collection('employees').doc(existingEmployee.id).update(employee);
                            } else {
                                // Add new employee
                                await db.collection('employees').add(employee);
                                importedCount++;
                            }
                        }
                        
                        // Reset file input
                        fileInput.value = '';
                        document.getElementById('file-name').textContent = 'لم يتم اختيار ملف';
                        document.getElementById('import-btn').disabled = true;
                        
                        showToast(`تم استيراد ${importedCount} موظف جديد بنجاح`);
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showToast('حدث خطأ أثناء معالجة ملف الإكسل', 'error');
                    }
                    
                    hideLoading();
                };
                
                reader.onerror = () => {
                    showToast('حدث خطأ أثناء قراءة الملف', 'error');
                    hideLoading();
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error importing data:', error);
                showToast('حدث خطأ أثناء استيراد البيانات', 'error');
                hideLoading();
            }
        });

        // Download template
        document.getElementById('download-template-btn').addEventListener('click', () => {
            // Create a template workbook
            const wb = XLSX.utils.book_new();
            
            // Define columns
            const columns = [
                'رقم الموظف',
                'الاسم',
                'الجنس',
                'المسمى الوظيفي',
                'البريد الإلكتروني',
                'رقم الهاتف',
                'تاريخ التعيين',
                'تاريخ انتهاء العقد',
                'تاريخ انتهاء إخطار التعيين',
                'القسم',
                'نوع العقد'
            ];
            
            // Create a sample row
            const sampleRow = {
                'رقم الموظف': '1001',
                'الاسم': 'محمد أحمد',
                'الجنس': 'ذكر',
                'المسمى الوظيفي': 'مطور برمجيات',
                'البريد الإلكتروني': 'example@example.com',
                'رقم الهاتف': '0555555555',
                'تاريخ التعيين': '2023-01-01',
                'تاريخ انتهاء العقد': '2024-01-01',
                'تاريخ انتهاء إخطار التعيين': '2023-12-01',
                'القسم': 'تكنولوجيا المعلومات',
                'نوع العقد': 'دائم'
            };
            
            // Create worksheet with headers and sample row
            const ws = XLSX.utils.json_to_sheet([sampleRow], { header: columns });
            
            // Add the worksheet to the workbook
            XLSX.utils.book_append_sheet(wb, ws, 'قالب الموظفين');
            
            // Generate and download the file
            XLSX.writeFile(wb, 'قالب_بيانات_الموظفين.xlsx');
            
            showToast('تم تنزيل القالب بنجاح');
        });

        // Export data to Excel
        document.getElementById('export-btn').addEventListener('click', async () => {
            showLoading();
            
            try {
                // Get export options
                const exportAll = document.getElementById('export-all').checked;
                const exportActiveOnly = document.getElementById('export-active-only').checked;
                const exportContracts = document.getElementById('export-contracts').checked;
                const exportTerminated = document.getElementById('export-terminated').checked;
                const exportFormat = document.getElementById('export-format').value;
                
                // Filter employees based on options
                let employeesToExport = [...employees];
                
                if (exportActiveOnly) {
                    employeesToExport = employeesToExport.filter(emp => emp.status === 'نشط');
                }
                
                // Create a workbook
                const wb = XLSX.utils.book_new();
                
                // Create employees worksheet
                const employeesData = employeesToExport.map(emp => ({
                    'رقم الموظف': emp.number || '',
                    'الاسم': emp.name || '',
                    'الجنس': emp.gender || '',
                    'المسمى الوظيفي': emp.position || '',
                    'القسم': emp.department || '',
                    'البريد الإلكتروني': emp.email || '',
                    'رقم الهاتف': emp.phone || '',
                    'تاريخ التعيين': emp.hireDate || '',
                    'تاريخ انتهاء العقد': emp.contractEndDate || '',
                    'تاريخ انتهاء إخطار التعيين': emp.noticeEndDate || '',
                    'نوع العقد': emp.contractType || '',
                    'الحالة': emp.status || ''
                }));
                
                const employeesWs = XLSX.utils.json_to_sheet(employeesData);
                XLSX.utils.book_append_sheet(wb, employeesWs, 'الموظفين');
                
                // Add contracts worksheet if selected
                if (exportContracts) {
                    // Filter contracts for the exported employees
                    const employeeIds = employeesToExport.map(emp => emp.id);
                    const contractsToExport = contracts.filter(contract => employeeIds.includes(contract.employeeId));
                    
                    const contractsData = contractsToExport.map(contract => {
                        const employee = employees.find(emp => emp.id === contract.employeeId);
                        return {
                            'رقم العقد': contract.number || '',
                            'الموظف': employee ? employee.name : '',
                            'رقم الموظف': employee ? employee.number : '',
                            'نوع العقد': contract.type || '',
                            'الراتب': contract.salary || '',
                            'تاريخ البدء': contract.startDate || '',
                            'تاريخ الانتهاء': contract.endDate || '',
                            'تاريخ انتهاء الإخطار': contract.noticeEndDate || '',
                            'ملاحظات': contract.notes || ''
                        };
                    });
                    
                    const contractsWs = XLSX.utils.json_to_sheet(contractsData);
                    XLSX.utils.book_append_sheet(wb, contractsWs, 'العقود');
                }
                
                // Add terminated employees worksheet if selected
                if (exportTerminated) {
                    const terminatedData = terminations.map(termination => {
                        const employee = employees.find(emp => emp.id === termination.employeeId);
                        return {
                            'رقم الموظف': employee ? employee.number : '',
                            'اسم الموظف': employee ? employee.name : '',
                            'المسمى الوظيفي': employee ? employee.position : '',
                            'القسم': employee ? employee.department : '',
                            'تاريخ التعيين': employee ? employee.hireDate : '',
                            'تاريخ انتهاء الخدمة': termination.terminationDate || '',
                            'سبب انتهاء الخدمة': termination.terminationType || '',
                            'ملاحظات': termination.notes || ''
                        };
                    });
                    
                    const terminatedWs = XLSX.utils.json_to_sheet(terminatedData);
                    XLSX.utils.book_append_sheet(wb, terminatedWs, 'الموظفين المنتهين');
                }
                
                // Generate and download the file
                const fileName = `بيانات_الموظفين_${new Date().toISOString().split('T')[0]}.${exportFormat}`;
                XLSX.writeFile(wb, fileName);
                
                showToast('تم تصدير البيانات بنجاح');
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('حدث خطأ أثناء تصدير البيانات', 'error');
            }
            
            hideLoading();
        });

        // Reports functionality
        document.getElementById('generate-employee-report').addEventListener('click', () => {
            const employeeId = document.getElementById('report-employee').value;
            
            if (!employeeId) {
                showToast('الرجاء اختيار موظف', 'error');
                return;
            }
            
            generateEmployeeReport(employeeId);
        });
        
        document.getElementById('generate-all-report').addEventListener('click', () => {
            const reportType = document.getElementById('report-type').value;
            generateAllEmployeesReport(reportType);
        });
        
        function generateEmployeeReport(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            
            if (!employee) {
                showToast('لم يتم العثور على الموظف', 'error');
                return;
            }
            
            // Get employee contracts
            const employeeContracts = contracts.filter(contract => contract.employeeId === employeeId);
            
            // Get employee termination if any
            const employeeTermination = terminations.find(termination => termination.employeeId === employeeId);
            
            // Show report section
            const reportResult = document.getElementById('report-result');
            reportResult.classList.remove('hidden');
            
            // Set report title
            document.getElementById('report-title').textContent = `تقرير الموظف: ${employee.name} (${employee.number})`;
            
            // Create table headers
            const tableHead = document.getElementById('report-table-head');
            tableHead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" colspan="2">معلومات الموظف</th>
                </tr>
            `;
            
            // Create table body
            const tableBody = document.getElementById('report-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">رقم الموظف</td>
                    <td class="px-6 py-4 text-sm">${employee.number || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">الاسم</td>
                    <td class="px-6 py-4 text-sm">${employee.name || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">الجنس</td>
                    <td class="px-6 py-4 text-sm">${employee.gender || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">المسمى الوظيفي</td>
                    <td class="px-6 py-4 text-sm">${employee.position || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">القسم</td>
                    <td class="px-6 py-4 text-sm">${employee.department || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">البريد الإلكتروني</td>
                    <td class="px-6 py-4 text-sm">${employee.email || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">رقم الهاتف</td>
                    <td class="px-6 py-4 text-sm">${employee.phone || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">تاريخ التعيين</td>
                    <td class="px-6 py-4 text-sm">${employee.hireDate || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">تاريخ انتهاء العقد</td>
                    <td class="px-6 py-4 text-sm">${employee.contractEndDate || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">تاريخ انتهاء إخطار التعيين</td>
                    <td class="px-6 py-4 text-sm">${employee.noticeEndDate || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">نوع العقد</td>
                    <td class="px-6 py-4 text-sm">${employee.contractType || ''}</td>
                </tr>
                <tr>
                    <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">الحالة</td>
                    <td class="px-6 py-4 text-sm">${employee.status || ''}</td>
                </tr>
            `;
            
            // Add contracts section if there are any
            if (employeeContracts.length > 0) {
                tableBody.innerHTML += `
                    <tr>
                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" colspan="2">العقود</th>
                    </tr>
                `;
                
                employeeContracts.forEach(contract => {
                    tableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">رقم العقد</td>
                            <td class="px-6 py-4 text-sm">${contract.number || ''}</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">نوع العقد</td>
                            <td class="px-6 py-4 text-sm">${contract.type || ''}</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">تاريخ البدء</td>
                            <td class="px-6 py-4 text-sm">${contract.startDate || ''}</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">تاريخ الانتهاء</td>
                            <td class="px-6 py-4 text-sm">${contract.endDate || 'غير محدد'}</td>
                        </tr>
                    `;
                });
            }
            
            // Add termination section if there is one
            if (employeeTermination) {
                tableBody.innerHTML += `
                    <tr>
                        <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" colspan="2">انتهاء الخدمة</th>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">تاريخ انتهاء الخدمة</td>
                        <td class="px-6 py-4 text-sm">${employeeTermination.terminationDate || ''}</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">سبب انتهاء الخدمة</td>
                        <td class="px-6 py-4 text-sm">${employeeTermination.terminationType || ''}</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right font-medium">ملاحظات</td>
                        <td class="px-6 py-4 text-sm">${employeeTermination.notes || ''}</td>
                    </tr>
                `;
            }
            
            // Set up export button
            document.getElementById('export-report').onclick = () => {
                exportEmployeeReport(employee, employeeContracts, employeeTermination);
            };
        }
        
        function generateAllEmployeesReport(reportType) {
            let filteredEmployees = [...employees];
            let reportTitle = 'تقرير جميع الموظفين';
            
            // Apply filter based on report type
            if (reportType === 'active') {
                filteredEmployees = filteredEmployees.filter(emp => emp.status === 'نشط');
                reportTitle = 'تقرير الموظفين النشطين';
            } else if (reportType === 'expiring') {
                const today = new Date();
                const oneMonthLater = new Date();
                oneMonthLater.setMonth(today.getMonth() + 1);
                
                // Filter employees with contracts ending within a month
                filteredEmployees = filteredEmployees.filter(emp => {
                    if (!emp.contractEndDate) return false;
                    
                    const endDate = new Date(emp.contractEndDate);
                    return endDate >= today && endDate <= oneMonthLater;
                });
                
                reportTitle = 'تقرير الموظفين قرب انتهاء عقودهم';
            } else if (reportType === 'new') {
                const today = new Date();
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(today.getMonth() - 1);
                
                // Filter employees hired within the last month
                filteredEmployees = filteredEmployees.filter(emp => {
                    if (!emp.hireDate) return false;
                    
                    const hireDate = new Date(emp.hireDate);
                    return hireDate >= oneMonthAgo && hireDate <= today;
                });
                
                reportTitle = 'تقرير الموظفين الجدد';
            } else if (reportType === 'terminated') {
                // Get all employees with terminations
                const terminatedEmployeeIds = terminations.map(t => t.employeeId);
                filteredEmployees = filteredEmployees.filter(emp => terminatedEmployeeIds.includes(emp.id));
                
                reportTitle = 'تقرير الموظفين المنتهين';
            }
            
            // Show report section
            const reportResult = document.getElementById('report-result');
            reportResult.classList.remove('hidden');
            
            // Set report title
            document.getElementById('report-title').textContent = reportTitle;
            
            // Create table headers
            const tableHead = document.getElementById('report-table-head');
            tableHead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">رقم الموظف</th>
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الاسم</th>
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الجنس</th>
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">المسمى الوظيفي</th>
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">القسم</th>
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ التعيين</th>
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ انتهاء العقد</th>
                    ${reportType === 'terminated' ? '<th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ انتهاء الخدمة</th>' : ''}
                    <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                </tr>
            `;
            
            // Create table body
            const tableBody = document.getElementById('report-table-body');
            
            if (filteredEmployees.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="${reportType === 'terminated' ? '9' : '8'}">لا يوجد موظفين ضمن هذا التقرير</td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = '';
                
                filteredEmployees.forEach(employee => {
                    const termination = terminations.find(t => t.employeeId === employee.id);
                    
                    tableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 text-sm">${employee.number || ''}</td>
                            <td class="px-6 py-4 text-sm">${employee.name || ''}</td>
                            <td class="px-6 py-4 text-sm">${employee.gender || ''}</td>
                            <td class="px-6 py-4 text-sm">${employee.position || ''}</td>
                            <td class="px-6 py-4 text-sm">${employee.department || ''}</td>
                            <td class="px-6 py-4 text-sm">${employee.hireDate || ''}</td>
                            <td class="px-6 py-4 text-sm">${employee.contractEndDate || ''}</td>
                            ${reportType === 'terminated' ? `<td class="px-6 py-4 text-sm">${termination ? termination.terminationDate : ''}</td>` : ''}
                            <td class="px-6 py-4 text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${employee.status === 'نشط' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : employee.status === 'إجازة' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                    ${employee.status || ''}
                                </span>
                            </td>
                        </tr>
                    `;
                });
            }
            
            // Set up export button
            document.getElementById('export-report').onclick = () => {
                exportAllEmployeesReport(filteredEmployees, reportTitle, reportType === 'terminated');
            };
        }
        
        function exportEmployeeReport(employee, employeeContracts, employeeTermination) {
            try {
                // Create a workbook
                const wb = XLSX.utils.book_new();
                
                // Create employee info worksheet
                const employeeWs = XLSX.utils.json_to_sheet([
                    { 'البيان': 'رقم الموظف', 'القيمة': employee.number || '' },
                    { 'البيان': 'الاسم', 'القيمة': employee.name || '' },
                    { 'البيان': 'الجنس', 'القيمة': employee.gender || '' },
                    { 'البيان': 'المسمى الوظيفي', 'القيمة': employee.position || '' },
                    { 'البيان': 'القسم', 'القيمة': employee.department || '' },
                    { 'البيان': 'البريد الإلكتروني', 'القيمة': employee.email || '' },
                    { 'البيان': 'رقم الهاتف', 'القيمة': employee.phone || '' },
                    { 'البيان': 'تاريخ التعيين', 'القيمة': employee.hireDate || '' },
                    { 'البيان': 'تاريخ انتهاء العقد', 'القيمة': employee.contractEndDate || '' },
                    { 'البيان': 'تاريخ انتهاء إخطار التعيين', 'القيمة': employee.noticeEndDate || '' },
                    { 'البيان': 'نوع العقد', 'القيمة': employee.contractType || '' },
                    { 'البيان': 'الحالة', 'القيمة': employee.status || '' }
                ]);
                
                XLSX.utils.book_append_sheet(wb, employeeWs, 'معلومات الموظف');
                
                // Add contracts worksheet if there are any
                if (employeeContracts.length > 0) {
                    const contractsData = employeeContracts.map(contract => ({
                        'رقم العقد': contract.number || '',
                        'نوع العقد': contract.type || '',
                        'الراتب': contract.salary || '',
                        'تاريخ البدء': contract.startDate || '',
                        'تاريخ الانتهاء': contract.endDate || '',
                        'تاريخ انتهاء الإخطار': contract.noticeEndDate || '',
                        'ملاحظات': contract.notes || ''
                    }));
                    
                    const contractsWs = XLSX.utils.json_to_sheet(contractsData);
                    XLSX.utils.book_append_sheet(wb, contractsWs, 'العقود');
                }
                
                // Add termination worksheet if there is one
                if (employeeTermination) {
                    const terminationData = [
                        { 'البيان': 'تاريخ انتهاء الخدمة', 'القيمة': employeeTermination.terminationDate || '' },
                        { 'البيان': 'سبب انتهاء الخدمة', 'القيمة': employeeTermination.terminationType || '' },
                        { 'البيان': 'ملاحظات', 'القيمة': employeeTermination.notes || '' }
                    ];
                    
                    const terminationWs = XLSX.utils.json_to_sheet(terminationData);
                    XLSX.utils.book_append_sheet(wb, terminationWs, 'انتهاء الخدمة');
                }
                
                // Generate and download the file
                const fileName = `تقرير_الموظف_${employee.name}_${employee.number}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('تم تصدير التقرير بنجاح');
            } catch (error) {
                console.error('Error exporting employee report:', error);
                showToast('حدث خطأ أثناء تصدير التقرير', 'error');
            }
        }
        
        function exportAllEmployeesReport(filteredEmployees, reportTitle, includeTerminations) {
            try {
                // Create a workbook
                const wb = XLSX.utils.book_new();
                
                // Create employees worksheet
                const employeesData = filteredEmployees.map(emp => {
                    const data = {
                        'رقم الموظف': emp.number || '',
                        'الاسم': emp.name || '',
                        'الجنس': emp.gender || '',
                        'المسمى الوظيفي': emp.position || '',
                        'القسم': emp.department || '',
                        'البريد الإلكتروني': emp.email || '',
                        'رقم الهاتف': emp.phone || '',
                        'تاريخ التعيين': emp.hireDate || '',
                        'تاريخ انتهاء العقد': emp.contractEndDate || '',
                        'تاريخ انتهاء إخطار التعيين': emp.noticeEndDate || '',
                        'نوع العقد': emp.contractType || '',
                        'الحالة': emp.status || ''
                    };
                    
                    if (includeTerminations) {
                        const termination = terminations.find(t => t.employeeId === emp.id);
                        if (termination) {
                            data['تاريخ انتهاء الخدمة'] = termination.terminationDate || '';
                            data['سبب انتهاء الخدمة'] = termination.terminationType || '';
                        }
                    }
                    
                    return data;
                });
                
                const employeesWs = XLSX.utils.json_to_sheet(employeesData);
                XLSX.utils.book_append_sheet(wb, employeesWs, 'الموظفين');
                
                // Generate and download the file
                const fileName = `${reportTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('تم تصدير التقرير بنجاح');
            } catch (error) {
                console.error('Error exporting employees report:', error);
                showToast('حدث خطأ أثناء تصدير التقرير', 'error');
            }
        }

        // Update dashboard with current data
        function updateDashboard() {
            // Update counter cards
            document.getElementById('total-employees').textContent = employees.length;
            
            // Count new employees (hired in the last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            const newEmployees = employees.filter(emp => {
                if (!emp.hireDate) return false;
                const hireDate = new Date(emp.hireDate);
                return hireDate >= thirtyDaysAgo && hireDate <= today;
            });
            
            document.getElementById('new-employees-count').textContent = newEmployees.length;
            
            // Count contracts expiring within 30 days
            const thirtyDaysLater = new Date();
            thirtyDaysLater.setDate(today.getDate() + 30);
            
            let expiringContracts = 0;
            
            employees.forEach(employee => {
                if (employee.contractEndDate) {
                    const endDate = new Date(employee.contractEndDate);
                    if (endDate >= today && endDate <= thirtyDaysLater) {
                        expiringContracts++;
                    }
                }
            });
            
            document.getElementById('expiring-contracts').textContent = expiringContracts;
            
            // Count terminated employees
            document.getElementById('terminated-employees').textContent = terminations.length;
            
            // Update new employees table
            const newEmployeesTable = document.getElementById('new-employees-table');
            
            // Get employees hired in the last 30 days
            const newEmployeesList = employees
                .filter(emp => emp.hireDate && new Date(emp.hireDate) >= thirtyDaysAgo)
                .sort((a, b) => new Date(b.hireDate) - new Date(a.hireDate))
                .slice(0, 5); // Show top 5
            
            if (newEmployeesList.length === 0) {
                newEmployeesTable.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="4">لا يوجد موظفين جدد</td>
                    </tr>
                `;
            } else {
                newEmployeesTable.innerHTML = '';
                
                newEmployeesList.forEach(employee => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.number || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.name || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.position || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${employee.hireDate || ''}</td>
                    `;
                    
                    newEmployeesTable.appendChild(row);
                });
            }
            
            // Update expiring contracts table
            const expiringItemsTable = document.getElementById('expiring-items-table');
            
            // Get contracts that expire within the next 30 days
            const expiringContractsList = [];
            
            employees.forEach(employee => {
                if (employee.contractEndDate) {
                    const endDate = new Date(employee.contractEndDate);
                    const daysLeft = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (endDate >= today && endDate <= thirtyDaysLater) {
                        expiringContractsList.push({
                            employee: employee.name,
                            type: 'عقد',
                            endDate: employee.contractEndDate,
                            daysLeft: daysLeft
                        });
                    }
                }
            });
            
            // Sort by days left (ascending)
            expiringContractsList.sort((a, b) => a.daysLeft - b.daysLeft);
            
            if (expiringContractsList.length === 0) {
                expiringItemsTable.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300" colspan="4">لا يوجد عقود تنتهي قريباً</td>
                    </tr>
                `;
            } else {
                expiringItemsTable.innerHTML = '';
                
                expiringContractsList.slice(0, 5).forEach(item => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${item.employee}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${item.type}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">${item.endDate}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.daysLeft <= 7 ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'}">
                                ${item.daysLeft} يوم
                            </span>
                        </td>
                    `;
                    
                    expiringItemsTable.appendChild(row);
                });
            }
        }

        // Add sample data for demonstration
        async function addSampleData() {
            showLoading();
            
            try {
                // Check if we already have data
                const employeesSnapshot = await db.collection('employees').limit(1).get();
                
                if (!employeesSnapshot.empty) {
                    // Data already exists, just return
                    hideLoading();
                    return;
                }
                
                // Sample employees
                const sampleEmployees = [
                    {
                        number: '1001',
                        name: 'أحمد محمد',
                        gender: 'ذكر',
                        department: 'تكنولوجيا المعلومات',
                        position: 'مطور برمجيات',
                        email: 'ahmad@example.com',
                        phone: '0501234567',
                        hireDate: '2023-01-15',
                        contractEndDate: '2024-01-15',
                        noticeEndDate: '2023-12-15',
                        contractType: 'دائم',
                        status: 'نشط'
                    },
                    {
                        number: '1002',
                        name: 'سارة علي',
                        gender: 'أنثى',
                        department: 'الموارد البشرية',
                        position: 'مديرة الموارد البشرية',
                        email: 'sara@example.com',
                        phone: '0551234567',
                        hireDate: '2022-05-10',
                        contractEndDate: '2024-05-10',
                        noticeEndDate: '2024-04-10',
                        contractType: 'دائم',
                        status: 'نشط'
                    },
                    {
                        number: '1003',
                        name: 'محمد خالد',
                        gender: 'ذكر',
                        department: 'المالية',
                        position: 'محاسب',
                        email: 'mohammed@example.com',
                        phone: '0561234567',
                        hireDate: '2023-06-01',
                        contractEndDate: '2023-12-01',
                        noticeEndDate: '2023-11-01',
                        contractType: 'مؤقت',
                        status: 'نشط'
                    },
                    {
                        number: '1004',
                        name: 'نورة عبدالله',
                        gender: 'أنثى',
                        department: 'التسويق',
                        position: 'مسؤولة تسويق',
                        email: 'noura@example.com',
                        phone: '0571234567',
                        hireDate: '2023-07-20',
                        contractEndDate: '2024-01-20',
                        noticeEndDate: '2023-12-20',
                        contractType: 'بدوام جزئي',
                        status: 'نشط'
                    },
                    {
                        number: '1005',
                        name: 'فهد سعيد',
                        gender: 'ذكر',
                        department: 'المبيعات',
                        position: 'مندوب مبيعات',
                        email: 'fahad@example.com',
                        phone: '0581234567',
                        hireDate: '2022-11-15',
                        contractEndDate: '2023-11-15',
                        noticeEndDate: '2023-10-15',
                        contractType: 'دائم',
                        status: 'منتهي'
                    }
                ];
                
                // Add employees to Firebase
                const employeeRefs = [];
                for (const employee of sampleEmployees) {
                    const docRef = await db.collection('employees').add(employee);
                    employeeRefs.push({ id: docRef.id, ...employee });
                }
                
                // Sample contracts
                const today = new Date();
                const nextMonth = new Date();
                nextMonth.setMonth(today.getMonth() + 1);
                
                const threeMonthsLater = new Date();
                threeMonthsLater.setMonth(today.getMonth() + 3);
                
                const sampleContracts = [
                    {
                        number: 'C-1001',
                        employeeId: employeeRefs[0].id,
                        type: 'دائم',
                        salary: '10000',
                        startDate: '2023-01-15',
                        endDate: '2024-01-15',
                        noticeEndDate: '2023-12-15',
                        notes: 'عقد عمل دائم'
                    },
                    {
                        number: 'C-1002',
                        employeeId: employeeRefs[1].id,
                        type: 'دائم',
                        salary: '12000',
                        startDate: '2022-05-10',
                        endDate: '2024-05-10',
                        noticeEndDate: '2024-04-10',
                        notes: 'عقد عمل دائم'
                    },
                    {
                        number: 'C-1003',
                        employeeId: employeeRefs[2].id,
                        type: 'مؤقت',
                        salary: '8000',
                        startDate: '2023-06-01',
                        endDate: formatDate(nextMonth),
                        noticeEndDate: formatDate(today),
                        notes: 'عقد مؤقت قابل للتجديد'
                    },
                    {
                        number: 'C-1004',
                        employeeId: employeeRefs[3].id,
                        type: 'بدوام جزئي',
                        salary: '5000',
                        startDate: '2023-07-20',
                        endDate: formatDate(threeMonthsLater),
                        noticeEndDate: formatDate(new Date(threeMonthsLater.getTime() - 30 * 24 * 60 * 60 * 1000)),
                        notes: 'عقد بدوام جزئي'
                    },
                    {
                        number: 'C-1005',
                        employeeId: employeeRefs[4].id,
                        type: 'دائم',
                        salary: '9000',
                        startDate: '2022-11-15',
                        endDate: '2023-11-15',
                        noticeEndDate: '2023-10-15',
                        notes: 'عقد عمل دائم'
                    }
                ];
                
                // Add contracts to Firebase
                for (const contract of sampleContracts) {
                    await db.collection('contracts').add(contract);
                }
                
                // Sample terminations
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(today.getDate() - 14);
                
                const sampleTerminations = [
                    {
                        employeeId: employeeRefs[4].id,
                        terminationType: 'استقالة',
                        terminationDate: formatDate(twoWeeksAgo),
                        notes: 'قدم الموظف استقالته بسبب الانتقال لوظيفة أخرى'
                    }
                ];
                
                // Add terminations to Firebase
                for (const termination of sampleTerminations) {
                    await db.collection('terminations').add(termination);
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error adding sample data:', error);
                hideLoading();
                showToast('حدث خطأ أثناء إضافة البيانات التجريبية', 'error');
            }
        }

        // Initialize the application
        async function initializeApp() {
            showLoading();
            
            try {
                // Add sample data if needed
                await addSampleData();
                
                // Fetch all data
                await fetchAllData();
                
                // Setup real-time listeners
                setupRealTimeListeners();
                
                // Show dashboard as the initial section
                showSection('dashboard');
                
                hideLoading();
            } catch (error) {
                console.error('Error initializing application:', error);
                hideLoading();
                showToast('حدث خطأ أثناء تهيئة التطبيق', 'error');
            }
        }

        // Initialize the application when the page loads
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
